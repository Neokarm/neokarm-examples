# [EBS CSI Driver](https://github.com/kubernetes-sigs/aws-ebs-csi-driver)

zCompute's AWS API can be leveraged to be used with AWS EBS CSI driver to provision and attach EBS volumes to concile with Kubernetes PVCs.

## Support matrix with zCompute:

|       Feature        |     Supported      |
| :------------------: | :----------------: |
| Static Provisioning  |         ‚úÖ         |
| Dynamic Provisioning |         ‚úÖ         |
|     Block Volume     |         ‚úÖ         |
|   Volume Resizing    | ‚ùå (‚úÖ on v22.05+) |
|   Volume Snapshot    |   üü° (Untested)    |
|         NVMe         |   üü° (Untested)    |
|    Mount Options     |   üü° (Untested)    |

## Usage

### 1. download the helm chart locally:

```sh
helm repo add aws-ebs-csi-driver https://kubernetes-sigs.github.io/aws-ebs-csi-driver
helm repo update
helm pull aws-ebs-csi-driver/aws-ebs-csi-driver --untar --version=2.6.1
```

### 2. Add a timeout parameter to the CSI provisioner:

The following patch is relevant for version 2.6.1 of the EBS CSI driver, but can be used to deduce the changes required for other versions:

```patch
--- aws-ebs-csi-driver/templates/controller.yaml
+++ aws-ebs-csi-driver/templates/controller.yaml
@@ -154,6 +154,7 @@
             {{- end}}
             - --leader-election=true
             - --default-fstype={{ .Values.controller.defaultFsType }}
+            - --timeout=180s
           env:
             - name: ADDRESS
               value: /var/lib/csi/sockets/pluginproxy/csi.sock
```

To apply it:

```sh
patch -p 0 < provisioner-timeout.patch
```

### 3. Optional: Use custom ca-certificates bundle

In case that the cluster is using a custom or unknown CA, it is required to update the CA certificates bundle in the EBS driver.
This is done by mounting the CA certificate bundle from a config map.
The following patch is relevant for version 2.6.1 of the EBS CSI driver, but can be used to deduce the changes required for other versions:

```patch
--- aws-ebs-csi-driver/templates/controller.yaml
+++ aws-ebs-csi-driver/templates/controller.yaml
@@ -118,6 +118,8 @@
           volumeMounts:
             - name: socket-dir
               mountPath: /var/lib/csi/sockets/pluginproxy/
+            - name: ca-certificate-bundle
+              mountPath: /etc/ssl/certs
           ports:
             - name: healthz
               containerPort: 9808
@@ -261,3 +263,9 @@
       volumes:
         - name: socket-dir
           emptyDir: {}
+        - name: ca-certificate-bundle
+          configMap:
+            name: zcompute-ca-certificates-bundle
+            items:
+              - key: ca-certificates.crt
+                path: ca-certificates.crt
```

To apply it:

```sh
patch -p 0 < controller-ca-bundle.patch
```

#### Create the ca-certificate ConfigMap:

> If you used the provided terraform files to install the Kubernetes cluster, use the `ca-certificates.crt` that was generated by it.

```sh
kubectl -n kube-system create configmap --from-file=ca-certificates.crt zcompute-ca-certificates-bundle
```

Make sure that after you apply the helm chart patches there are no \*.orig file in the template directory.
If there are, delete them.

### 5. Install the modified helm chart with the additional changed values:

* Copy or rename `values.template.yaml` to `values.yaml` and replace `$ZCOMPUTE_HOSTNAME` with the zCompute cluster valid DNS.

* Deploy `aws-ebs-csi-driver`
  ```sh
  helm upgrade --install aws-ebs-csi-driver aws-ebs-csi-driver/ -f values.yaml -n kube-system
  ```
